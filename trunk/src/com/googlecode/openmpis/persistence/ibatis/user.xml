<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="User">
    <!-- Type alias allow you to use a shorter name for long fully qualified class names. -->
    <typeAlias alias="user" type="com.googlecode.openmpis.dto.User"/>
    
    <cacheModel id="userCache" type="LRU">
        <flushOnExecute statement="insertUser"/>
        <flushOnExecute statement="updateUser"/>
        <flushOnExecute statement="updatePassword"/>
        <flushOnExecute statement="updateLogin"/>
        <flushOnExecute statement="deleteUser"/>
        <flushInterval hours="24"/>
    </cacheModel>

    <sql id="userColumnsFragment">
        ID as id,
        GROUPID as groupId,
        USERNAME as username,
        FIRSTNAME as firstName,
        MIDDLENAME as middleName,
        LASTNAME as lastName,
        BIRTHMONTH as birthMonth,
        BIRTHDAY as birthDay,
        BIRTHYEAR as birthYear,
        EMAIL as email,
        DESIGNATION as designation,
        AGENCY as agency,
        NUMBER as number,
        IPADDRESS as ipAddress,
        LASTLOGIN as lastLogin,
        DATE as date,
        STATUS as status,
        CREATORID as creatorId,
        QUESTION as question,
        ANSWER as answer
        FROM user
    </sql>

    <sql id="administratorFragment">
        WHERE GROUPID = '0'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="activeAdministratorFragment">
        WHERE GROUPID = '0' AND STATUS = '0'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="suspendedAdministratorFragment">
        WHERE GROUPID = '0' AND STATUS = '1'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="encoderFragment">
        WHERE GROUPID = '1'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="activeEncoderFragment">
        WHERE GROUPID = '1' AND STATUS = '0'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="suspendedEncoderFragment">
        WHERE GROUPID = '1' AND STATUS = '1'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="investigatorFragment">
        WHERE GROUPID = '2'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="activeInvestigatorFragment">
        WHERE GROUPID = '2' AND STATUS = '0'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="suspendedInvestigatorFragment">
        WHERE GROUPID = '2' AND STATUS = '1'
        ORDER BY AGENCY, STATUS, LASTNAME, ID
    </sql>

    <sql id="activeFragment">
        WHERE STATUS = '0'
        ORDER BY AGENCY, GROUPID, LASTNAME, ID
    </sql>

    <sql id="suspendedFragment">
        WHERE STATUS = '1'
        ORDER BY AGENCY, GROUPID, LASTNAME, ID
    </sql>
    
    <!-- Use primitive wrapper type (e.g. Integer) as parameter and allow results to
    be auto-mapped results to User object (JavaBean) properties -->
    <select id="getUserByUsername" parameterClass="String" resultClass="user" cacheModel="userCache">
        <![CDATA[
        SELECT
        ID as id,
        GROUPID as groupId,
        USERNAME as username,
        PASSWORD as password,
        FIRSTNAME as firstName,
        LASTNAME as lastName,
        EMAIL as email,
        STATUS as status,
        QUESTION as question,
        ANSWER as answer,
        CREATORID as creatorId
        FROM user
        WHERE USERNAME LIKE BINARY #username# AND STATUS = '0'
        ]]>
    </select>
    
    <select id="getUserById" parameterClass="java.lang.Integer" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <![CDATA[
        WHERE ID = #id#
        ]]>
    </select>

    <!-- According to user ID -->
    <select id="getAllUsers" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        ORDER BY ID
    </select>

    <select id="countAllUsers" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
    </select>

    <select id="getAdministrators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="administratorFragment"/>
    </select>

    <select id="countAdministrators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="administratorFragment"/>
    </select>

    <select id="getActiveAdministrators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="activeAdministratorFragment"/>
    </select>

    <select id="countActiveAdministrators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="activeAdministratorFragment"/>
    </select>

    <select id="getSuspendedAdministrators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="suspendedAdministratorFragment"/>
    </select>

    <select id="countSuspendedAdministrators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="suspendedAdministratorFragment"/>
    </select>

    <select id="getEncoders" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="encoderFragment"/>
    </select>

    <select id="countEncoders" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="encoderFragment"/>
    </select>

    <select id="getActiveEncoders" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="activeEncoderFragment"/>
    </select>

    <select id="countActiveEncoders" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="activeEncoderFragment"/>
    </select>

    <select id="getSuspendedEncoders" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="suspendedEncoderFragment"/>
    </select>

    <select id="countSuspendedEncoders" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="suspendedEncoderFragment"/>
    </select>

    <select id="getInvestigators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="investigatorFragment"/>
    </select>

    <select id="countInvestigators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="investigatorFragment"/>
    </select>

    <select id="getActiveInvestigators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="activeInvestigatorFragment"/>
    </select>

    <select id="countActiveInvestigators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="activeInvestigatorFragment"/>
    </select>

    <select id="getSuspendedInvestigators" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="suspendedInvestigatorFragment"/>
    </select>

    <select id="countSuspendedInvestigators" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="suspendedInvestigatorFragment"/>
    </select>

    <select id="getActiveUsers" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="activeFragment"/>
    </select>

    <select id="countActiveUsers" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="activeFragment"/>
    </select>

    <select id="getSuspendedUsers" resultClass="user" cacheModel="userCache">
        SELECT
        <include refid="userColumnsFragment"/>
        <include refid="suspendedFragment"/>
    </select>

    <select id="countSuspendedUsers" resultClass="java.lang.Integer" cacheModel="userCache">
        SELECT
        COUNT(ID)
        FROM user
        <include refid="suspendedFragment"/>
    </select>

    <select id="countEncodedUsers" resultClass="java.lang.Integer" parameterClass="java.lang.Integer" cacheModel="userCache">
        <![CDATA[
        SELECT
        COUNT(ID)
        FROM user
        WHERE CREATORID = #creatorId#
        ]]>
    </select>
        
    <select id="checkUsername" parameterClass="user" resultClass="user" cacheModel="userCache">
        <![CDATA[
        SELECT
        USERNAME as username
        FROM user
        WHERE USERNAME = #username# AND ID != #id#
        ]]>
    </select>
        
    <select id="checkEmail" parameterClass="user" resultClass="user" cacheModel="userCache">
        <![CDATA[
        SELECT
        EMAIL as email
        FROM user
        WHERE EMAIL = #email# AND ID != #id#
        ]]>
    </select>

    <!-- Use User object (JavaBean) properties as parameters for insert. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <insert id="insertUser" parameterClass="user">
        <![CDATA[
        INSERT INTO user
        (GROUPID, USERNAME, PASSWORD, FIRSTNAME, MIDDLENAME, LASTNAME, BIRTHMONTH, BIRTHDAY, BIRTHYEAR,
        EMAIL, DESIGNATION, AGENCY, NUMBER, DATE, STATUS, CREATORID, QUESTION)
        VALUES
        (#groupId#, #username#, MD5(#password#), #firstName#, #middleName#, #lastName#, #birthMonth#, #birthDay#, #birthYear#,
        #email#, #designation#, #agency#, #number#, #date#, #status#, #creatorId#, #question#)
        ]]>
    </insert>

    <!-- Use User object (JavaBean) properties as parameters for update. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <update id="updateUser" parameterClass="user">
        <![CDATA[
        UPDATE user SET
        GROUPID = #groupId#,
        USERNAME = #username#,
        FIRSTNAME = #firstName#,
        MIDDLENAME = #middleName#,
        LASTNAME = #lastName#,
        BIRTHMONTH = #birthMonth#,
        BIRTHDAY = #birthDay#,
        BIRTHYEAR = #birthYear#,
        EMAIL = #email#,
        DESIGNATION = #designation#,
        AGENCY = #agency#,
        NUMBER = #number#,
        STATUS = #status#,
        QUESTION = #question#,
        ANSWER = #answer#
        WHERE ID = #id#
        ]]>
    </update>
    
    <update id="updatePassword" parameterClass="user">
        <![CDATA[
        UPDATE user SET
        PASSWORD = #password#
        WHERE ID = #id#
        ]]>
    </update>
    
    <update id="updateLogin" parameterClass="user">
        <![CDATA[
        UPDATE user SET
        IPADDRESS = #ipAddress#,
        LASTLOGIN = #lastLogin#
        WHERE ID = #id#
        ]]>
    </update>

    <!-- Use User object (JavaBean) “id” properties as parameters for delete. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <delete id="deleteUser" parameterClass="java.lang.Integer">
        <![CDATA[
        DELETE FROM user
        WHERE ID = #id#
        ]]>
    </delete>
</sqlMap>