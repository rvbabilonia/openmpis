<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="Report">
    <!-- Type alias allow you to use a shorter name for long fully qualified class names. -->
    <typeAlias alias="report" type="com.googlecode.openmpis.dto.Report"/>
    
    <cacheModel id="reportCache" type="LRU">
        <flushOnExecute statement="insertReport"/>
        <flushOnExecute statement="updateReport"/>
        <flushOnExecute statement="deleteReport"/>
        <flushInterval hours="24"/>
    </cacheModel>
    
    <!-- Use primitive wrapper type (e.g. Integer) as parameter and allow results to
    be auto-mapped results to Person object (JavaBean) properties -->
    <select id="getReportById" parameterClass="java.lang.Integer" resultClass="report" cacheModel="reportCache">
        <![CDATA[
        SELECT
        REPORT.ID as id,
        REPORT.REPORT as report,
        REPORT.DATE as date,
        REPORT.INVESTIGATORID as investigatorId,
        REPORT.PERSONID as personId,
        PERSON.FIRSTNAME as firstName,
        PERSON.LASTNAME as lastName
        FROM REPORT, PERSON
        WHERE REPORT.ID = #id#
        AND REPORT.PERSONID = PERSON.ID
        ]]>
    </select>

    <select id="getAllReportsByInvestigatorId" parameterClass="java.lang.Integer" resultClass="report" cacheModel="reportCache">
        <![CDATA[
        SELECT
        REPORT.ID as id,
        REPORT.REPORT as report,
        REPORT.DATE as date,
        REPORT.INVESTIGATORID as investigatorId,
        REPORT.PERSONID as personId,
        PERSON.FIRSTNAME as firstName,
        PERSON.LASTNAME as lastName
        FROM REPORT, PERSON
        WHERE REPORT.INVESTIGATORID = #investigatorId#
        AND REPORT.PERSONID = PERSON.ID
        ORDER BY REPORT.PERSONID, REPORT.DATE DESC, REPORT.ID DESC
        ]]>
    </select>

    <select id="countAllReportsByInvestigatorId" parameterClass="java.lang.Integer" resultClass="java.lang.Integer" cacheModel="reportCache">
        <![CDATA[
        SELECT
        COUNT(ID)
        FROM REPORT
        WHERE INVESTIGATORID = #investigatorId#
        ]]>
    </select>

    <select id="getAllReportsForPerson" parameterClass="java.lang.Integer" resultClass="report" cacheModel="reportCache">
        <![CDATA[
        SELECT
        REPORT.ID as id,
        REPORT.REPORT as report,
        REPORT.DATE as date,
        REPORT.INVESTIGATORID as investigatorId,
        REPORT.PERSONID as personId,
        PERSON.FIRSTNAME as firstName,
        PERSON.LASTNAME as lastName
        FROM REPORT, PERSON
        WHERE REPORT.PERSONID = #personId#
        AND REPORT.PERSONID = PERSON.ID
        ORDER BY REPORT.DATE DESC, REPORT.ID DESC
        ]]>
    </select>

    <select id="countAllReportsForPerson" parameterClass="java.lang.Integer" resultClass="java.lang.Integer" cacheModel="reportCache">
        <![CDATA[
        SELECT
        COUNT(ID)
        FROM REPORT
        WHERE PERSONID = #personId#
        ]]>
    </select>

    <!-- Use Person object (JavaBean) properties as parameters for insert. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <insert id="insertReport" parameterClass="report">
        <![CDATA[
        INSERT INTO REPORT
        (REPORT, DATE, PERSONID, INVESTIGATORID)
        VALUES
        (#report#, #date#, #personId#, #investigatorId#)
        ]]>
    </insert>

    <!-- Use Person object (JavaBean) properties as parameters for update. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <update id="updateReport" parameterClass="report">
        <![CDATA[
        UPDATE REPORT SET
        REPORT = #report#,
        DATE = #date#,
        INVESTIGATORID = #investigatorId#
        WHERE ID = #id#
        ]]>
    </update>

    <!-- Use Person object (JavaBean) “id” properties as parameters for delete. Each of the
    parameters in the #hash# symbols is a JavaBeans property. -->
    <delete id="deleteReport" parameterClass="java.lang.Integer">
        <![CDATA[
        DELETE FROM REPORT
        WHERE ID = #id#
        ]]>
    </delete>

    <delete id="deleteReportsForPerson" parameterClass="java.lang.Integer">
        <![CDATA[
        DELETE FROM REPORT
        WHERE PERSONID = #personId#
        ]]>
    </delete>
</sqlMap>